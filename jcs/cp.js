/*ControlPosts4.0.0 - SomeBottle202105*/
var md=new showdown.Converter,editpost="none",tpjs=JSON.parse(window.tjson);renderlist();loadhide();var choose=0,timer;function rmj(){return"main."+Math.random().toString(36).substr(5)+".json"}function getdate(){var a=new Date,b=a.getMonth()+1,c=a.getDate();1<=b&&9>=b&&(b="0"+b);1<=c&&9>=c&&(c="0"+c);return a.getFullYear()+b.toString()+c.toString()}var B={r:function(a,b,c,e,d){e=void 0===e?!1:e;d=void 0===d?!0:d;if(a){if(e)return"("==e?a.replace(new RegExp("\\{\\("+b+"\\)\\}",(d?"g":"")+"i"),c):a.replace(new RegExp("\\{\\["+b+"\\]\\}",(d?"g":"")+"i"),c);if(d)for(;-1!==a.indexOf(b);)a=a.replace(b,c);else a=a.replace(b,c)}return a},gt:function(a,b,c,e){c=void 0===c?!1:c;e=void 0===e?!1:e;c=c?c:document.getElementsByTagName("html")[0].innerHTML;try{var d=e?c.split(a)[1]:c.split(new RegExp("\\{\\("+a+"\\)\\}","i"))[1];return e?d.split(b)[0]:d.split(new RegExp("\\{\\("+b+"\\)\\}","i"))[0]}catch(h){return!1}}};function renderlist(){var a=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),b="",c=0,e;for(e in a.dateindex){if(8<=c)break;var d=parseInt(e.replace("post","")),h=Base64.decode(a.postindex[d].title),b=b+("\x3cp class\x3d'postitemp'\x3e\x3ca class\x3d'postitema' href\x3d'javascript:void(0);' onclick\x3d'postopen("+d+")'\x3e"+h+"\x3c/a\x3e\x3c/p\x3e"),c=c+1}""==b&&(b+="\x3cp class\x3d'postitemp'\x3e\x3ca class\x3d'postitema' href\x3d'javascript:void(0);'\x3e\u8fd8\u6ca1\u6709\u6587\u7ae0\u5462\x3c/a\x3e\x3c/p\x3e");SC("rp").innerHTML=b}function eswitch(){choose+=1;7<=choose&&(choose=7);5==choose?SC("fbtn").style.backgroundColor="#FA5858":SC("fbtn").style.backgroundColor="#0080ff";SC("fbtn").innerHTML="\u7f16\u8f91/\u53d1\u5e03 \u9884\u89c8 \u4fdd\u5b58\u8349\u7a3f \u8bfb\u53d6\u8349\u7a3f \u5220\u9664 \u751f\u6210\u5f52\u6863 \u53d6\u6d88".split(" ")[choose-1];clearTimeout(timer);timer=setTimeout(function(){switch(choose){case 1:edit();console.log("\u7f16\u8f91/\u53d1\u5e03");break;case 2:console.log("\u9884\u89c8");preview();break;case 3:console.log("\u4fdd\u5b58\u8349\u7a3f");tempsave();break;case 4:console.log("\u8bfb\u53d6\u8349\u7a3f");readsave();break;case 5:console.log("\u5220\u9664");"none"==editpost?notice("\u73b0\u5728\u6ca1\u6709\u7f16\u8f91\u4efb\u4f55\u6587\u7ae0"):confirm("\u771f\u7684\u8981\u5220\u9664\u5f53\u524d\u6587\u7ae0\u5417\uff1f\uff01")&&delpost(editpost);break;case 6:console.log("\u751f\u6210\u5f52\u6863");tagarchive();break;case 7:console.log("\u53d6\u6d88")}SC("fbtn").innerHTML="O_o?";SC("fbtn").style.backgroundColor="#0080ff";choose=0},1E3)}function scriptcutter(a){var b=document.createElement("div");b.innerHTML=a;a=b.getElementsByTagName("script");for(var c in a){var e=a[c].innerHTML;void 0!==e&&(e=B.r(e,"/*",""),e=B.r(e,"*/",""),prc="/*"+e+"*/",a[c].innerHTML=prc)}return b.innerHTML}function enhtml(a){return a.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;").replace(/"/g,"\x26quot;").replace(/'/g,"\x26#039;")}function dehtml(a){return a.replace(/&amp;/g,"\x26").replace(/&lt;/g,"\x3c").replace(/&gt;/g,"\x3e").replace(/&nbsp;/g," ").replace(/&#039;/g,"'").replace(/&quot;/g,'"')}function tagarchive(){var a=tpjs.templatehtmls.tags,b=tpjs.templatehtmls.archives,c=tpjs.generatehtmls.tags,e=tpjs.generatehtmls.archives,d=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),h=window.htmls["index.html"],k=B.r(h,"title","Tags",!0),k=B.r(k,"titlemiddle","-",!0),k=B.r(k,"sitename",d.name,!0),k=B.r(k,"keywords",d.name+",tag",!0),k=B.r(k,"description","Tag Page",!0),f=B.r(k,"type",a,!0),a=B.r(h,"title","Archives",!0),a=B.r(a,"titlemiddle","-",!0),a=B.r(a,"sitename",d.name,!0),d=B.r(a,"keywords",d.name+",archive",!0),d=B.r(d,"description","Archive Page",!0),l=B.r(d,"type",b,!0);confirm("\u786e\u5b9a\u8981\u751f\u6210\u6807\u7b7e\u548c\u5f52\u6863\u9875\u9762\uff1f")&&(loadshow(),(new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,f,{success:function(b){var f=[];f.push({path:c,mode:"100644",type:"blob",sha:b.sha});a(f)},failed:function(a){notice("\u751f\u6210\u5931\u8d25",!0);loadhide()}})})).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,l,{success:function(c){a.push({path:e,mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u751f\u6210\u5931\u8d25",!0);loadhide()}})})}).then(function(a){blog.gpush(window.accesstoken,window.githubrepo,a,"Add Archives Page and Tags Page",{success:function(a){notice("\u751f\u6210\u6210\u529f");loadhide()},failed:function(a){notice("\u751f\u6210push\u5931\u8d25",!0);loadhide()}})}))}function covercutter(a){for(;-1!==a.indexOf("\x3cifcover\x3e");){var b=B.gt("\x3cifcover\x3e","\x3c/ifcover\x3e",a,!0);a=B.r(a,"\x3cifcover\x3e"+b+"\x3c/ifcover\x3e","")}return a}function transdate(a){a=String(a);var b=a.slice(-4),c=b.slice(-2),e=b.substring(0,2);return a.replace(b,"")+"-"+e+"-"+c}function indexrenderer(a){var b=tpjs.templatehtmls.postlist,c=window.htmls["index.html"],e=window.htmls["postitem.html"],e=B.gt("PostItem","PostItemEnd",e),d=a.dateindex,h="",k=parseInt(a.posts_per_page),f=0,l;for(l in d)if(f<k){var g=l.replace("post",""),d=a.postindex[g];if(d.link)--f;else var n=B.r(e,"postitemtitle",Base64.decode(d.title),!0),n=B.r(n,"postitemintro",Base64.decode(d.intro)+"...",!0),n=B.r(n,"postitemdate",transdate(d.date),!0),n=B.r(n,"postitemtags",d.tags.replace(/,/g,"\u00b7"),!0),g=B.r(n,"postitemlink","post-"+g+".html",!0),g=d.cover?B.r(g,"postcover",d.cover,!0):covercutter(g),h=h+g;f+=1}else break;c=B.r(c,"title","",!0);c=B.r(c,"titlemiddle","",!0);c=B.r(c,"description","",!0);c=B.r(c,"keywords",a.name,!0);b=B.r(c,"type",b,!0);a=B.r(b,"sitename",a.name,!0);return B.r(a,"content",enhtml(h),!0)}function tempsave(){function a(a,b){var c=JSON.parse(localStorage[a]||"[]"),d={};d.v=b;d.t=new Date;10<=c.length&&c.shift();c.push(d);localStorage[a]=JSON.stringify(c)}var b=SC("title").value,c=SC("date").value,e=SC("tag").value,d=SC("content").value;a("otitle",b);a("odate",c);a("otag",e);a("ocontent",d);notice("\u4fdd\u5b58\u6210\u529f")}function readsave(){function a(a,b){b=void 0===b?!1:b;var c=JSON.parse(localStorage[a]||"[]");return 0<=parseInt(b)?c[b]||!1:c}var b="",c=a("otitle"),e;for(e in c)b+="\u5e8f\u53f7:"+e+" \u4fdd\u5b58\u65f6\u95f4:"+c[e].t+"\n";b=parseInt(prompt("\u8bf7\u8f93\u5165\u8981\u8bfb\u53d6\u7684\u8349\u7a3f\u5e8f\u53f7\n"+b+"\n\n\u8fd9\u4f1a\u8986\u76d6\u4f60\u76ee\u524d\u7684\u5185\u5bb9",""));(c=a("otitle",b))&&0<=b?(SC("title").value=c.v,SC("date").value=a("odate",b).v,SC("tag").value=a("otag",b).v,SC("content").value=a("ocontent",b).v):notice("\u65e0\u6b64\u8349\u7a3f")}function preview(){var a=SC("content").value,a=B.r(a,"/*",""),a=B.r(a,"*/",""),b=window.open("");b.opener=null;b.document.write(md.makeHtml(a));b.document.close()}function coverdrawer(){return B.gt("-[cover:","]-",SC("content").value,!0)}function edit(){window.editprogress="doing";var a=tpjs.templatehtmls.post,b=SC("title").value;if(b.match(/^[ ]+$/)||""==b)return notice("\u6807\u9898\u4e0d\u80fd\u4e3a\u7a7a\u54e6"),!1;var c=SC("date").value;if(c.match(/^[ ]+$/)||""==c)c=getdate();var e=SC("tag").value,d=scriptcutter(SC("content").value),h=!1;if(isNaN(c)){h=!0;if(-1!==tpjs.alltp.indexOf(c+".html"))return notice("\u94fe\u63a5\u540d\u4e0e\u6a21\u677f\u91cd\u590d\uff01"),notice("\u8bf7\u66f4\u6362"),!1;e=""}var k=md.makeHtml(d).replace(/<\/?.+?>/g,"").substring(0,100).replace(/[ ]/g,"").replace(/[\r\n]/g,"");70<=d.length&&(k+="...");if(confirm("\u771f\u7684\u8981\u53d1\u5e03\u561b\uff1f")){var f=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),l=B.r(window.htmls["index.html"],"title",b,!0),l=B.r(l,"titlemiddle","-",!0),l=B.r(l,"date",c,!0),l=B.r(l,"tags",e,!0),d=B.r(l,"content",enhtml(d),!0),d=B.r(d,"description",k.replace(/<\/?.+?>/g,""),!0),d=B.r(d,"keywords",e+","+f.name,!0),a=B.r(d,"type",a,!0),a=B.r(a,"sitename",f.name,!0);"initialized"==f[0]&&delete f[0];f.postnum||(f.postnum=0);f.postindex||(f.postindex={});f.dateindex&&"object"===typeof f.dateindex||(f.dateindex={});var g=f.postnum,n="New post";"none"!==editpost?(g=editpost,n="Edit post"):f.postnum+=1;var p=B.r(a,"pid",g,!0),q="";h&&(q=c,c=getdate());f.dateindex["post"+g]=c+g.toString();var a=0,m;for(m in f.dateindex)d=f.dateindex[m].toString().length,d>a&&(a=d);for(m in f.dateindex)if(l=f.dateindex[m],d=l.toString().length,d<a){for(var v=m.replace("post","").toString(),r=a-d,w=0,x="";w<r;)x+=(0).toString(),w+=1;r=getdate().toString().length;r=l.toString().substring(0,r);d=l.toString().substring(d-v.length).toString().replace(v,x+v);f.dateindex[m]=parseInt(r+d)}m=[];for(var t in f.dateindex)m.push([t,parseInt(f.dateindex[t])]);f.dateindex={};m=m.sort(function(a,b){return a[1]-b[1]}).reverse();window.testarray=m;for(var z in m)t=m[z],f.dateindex[t[0]]=t[1];var u="";if("none"!==editpost&&!h&&f.postindex[g].link)return notice("\u4f60\u6b63\u5728\u7f16\u8f91\u9875\u9762"),notice("\u4e0d\u80fd\u8f6c\u4e3a\u6587\u7ae0"),!1;if("none"!==editpost&&h&&(u=f.postindex[g].link,!u))return notice("\u4f60\u6b63\u5728\u7f16\u8f91\u6587\u7ae0"),notice("\u4e0d\u80fd\u8f6c\u4e3a\u9875\u9762"),!1;f.postindex[g]={};f.postindex[g].title=Base64.encode(b);f.postindex[g].date=c;(b=coverdrawer())?(f.postindex[g].cover=b,"none"==b&&f.postindex[g].cover&&delete f.postindex[g].cover,p=B.r(p,"cover",b,!0)):p=B.r(p,"cover","none",!0);h&&(f.postindex[g].link=q);f.postindex[g].intro=Base64.encode(k);f.postindex[g].tags=e;loadshow();var y="post-"+g+".html";h&&(y=q+".html");var A=indexrenderer(f),C=tpjs.mainjson;tpjs.mainjson=rmj();(new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,p,{success:function(b){var c=[];c.push({path:y,mode:"100644",type:"blob",sha:b.sha});a(c)},failed:function(a){notice("\u7f16\u8f91/\u53d1\u5e03\u5931\u8d25",!0);loadhide()}})})).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(f),{success:function(c){a.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u7d22\u5f15\u4e0a\u8f7d\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,A,{success:function(c){a.push({path:"index.html",mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u9996\u9875\u66f4\u65b0\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:function(c){a.push({path:"template.json",mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u6a21\u677f\u7d22\u5f15\u66f4\u65b0\u5931\u8d25",!0);loadhide()}})})}).then(function(a){a.push({path:C,mode:"160000",type:"commit",sha:null});""!==u&&u!==q&&a.push({path:u+".html",mode:"160000",type:"commit",sha:null});return new Promise(function(b,c){blog.gpush(window.accesstoken,window.githubrepo,a,n,{success:function(a){b(JSON.parse(a))},failed:function(a){notice("\u66f4\u65b0push\u5931\u8d25",!0);loadhide()}})})}).then(function(a){blog.getfileshas(window.accesstoken,window.githubrepo,!0,{success:function(a){window.fileshas=a;window.editprogress="finish";window.mainjson.content=Base64.encode(JSON.stringify(f));window.tjson=JSON.stringify(tpjs)},failed:function(a){notice("\u5237\u65b0\u4e34\u65f6\u6587\u4ef6sha\u5217\u8868\u5931\u8d25",!0);loadhide()}},a.object.sha)});var D=setInterval(function(){"finish"==window.editprogress&&(window.gstate=0,window.editprogress="",notice("\u7f16\u8f91/\u53d1\u5e03\u6210\u529f"),renderlist(),"none"!==editpost?window.htmls[h?q+".html":"post-"+editpost+".html"]=Base64.encode(p):postopen(g),loadhide(),clearInterval(D))},1500)}}function delpost(a){var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,"")));if(b.postindex[a]){var c=b.postindex[a],e=!1;c.link&&(e=!0);delete b.postindex[a];delete b.dateindex["post"+a];loadshow();var d="post-"+a+".html";e&&(d=c.link+".html");var h=indexrenderer(b),k=tpjs.mainjson;tpjs.mainjson=rmj();(new Promise(function(a,c){blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(b),{success:function(b){var c=[];c.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:b.sha});a(c)},failed:function(a){notice("\u66f4\u65b0\u7d22\u5f15\u5931\u8d25",!0);loadhide()}})})).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:function(c){a.push({path:"template.json",mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u66f4\u65b0\u7d22\u5f15\u6a21\u677f\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(b,c){blog.cr(window.accesstoken,window.githubrepo,h,{success:function(c){a.push({path:"index.html",mode:"100644",type:"blob",sha:c.sha});b(a)},failed:function(a){notice("\u9996\u9875\u66f4\u65b0\u5931\u8d25",!0);loadhide()}})})}).then(function(a){a.push({path:d,mode:"160000",type:"commit",sha:null});a.push({path:k,mode:"160000",type:"commit",sha:null});blog.gpush(window.accesstoken,window.githubrepo,a,"Delete post/page",{success:function(a){window.mainjson.content=Base64.encode(JSON.stringify(b));window.tjson=JSON.stringify(tpjs);renderlist();notice("\u5220\u9664\u6210\u529f")},failed:function(a){notice("\u5220\u9664:\u66f4\u65b0push\u5931\u8d25",!0);loadhide()}})})}}function postopen(a){loadshow();var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),c=!1;b.postindex[a].link&&(c=!0);this.loadpost=function(d){loadhide();var e=Base64.decode(d);d=Base64.decode(b.postindex[a].title);var f=c?b.postindex[a].link:b.postindex[a].date,h=b.postindex[a].tags,e=B.gt("PostContent","PostContentEnd",e).trim();SC("content").value=dehtml(e);SC("tag").value=h;SC("title").value=d;SC("date").value=f;addshow();editpost=a};var e="post-"+a+".html";c&&(e=b.postindex[a].link+".html");if(window.htmls[e])this.loadpost(window.htmls[e]);else{var d=this;blog.getfileblob(window.accesstoken,window.githubrepo,blog.findfilesha(e),!0,{success:function(a){d.loadpost(a.content);window.htmls[e]=a.content},failed:function(a){loadhide();notice("\u52a0\u8f7d\u6587\u7ae0\u5931\u8d25");notice("No such post.")}})}}function addnew(){addhide();editpost="none";SC("content").value="";SC("tag").value="";SC("title").value="";SC("date").value=""}document.onkeydown=function(a){if((a=a||window.event)&&13==a.keyCode)if(a=SC("search").value,""!==a&&SC("search")==document.activeElement)SC("sbr").style.zIndex=50,SC("sbr").style.opacity=1,SC("sbr").innerHTML="\x3cp class\x3d'scitemp'\x3e\x3ca class\x3d'scitema' href\x3d'#Searching..'\x3e\u641c\u7d22\u4e2d...\x3c/a\x3e\x3c/p\x3e",searchrender(a);else return!0;else return!0};function searchrender(a){var b="",c=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))).postindex,e;for(e in c){var d=Base64.decode(c[e].title).toLowerCase(),h=Base64.decode(c[e].intro).toLowerCase(),k=c[e].date.toLowerCase(),f=c[e].tags.toLowerCase();a=a.toLowerCase();if(-1!==d.indexOf(a)||-1!==h.indexOf(a)||-1!==k.indexOf(a)||-1!==f.indexOf(a))b+="\x3cp class\x3d'scitemp'\x3e\x3ca class\x3d'scitema' href\x3d'javascript:void(0);' onclick\x3d'postopen("+e+")'\x3e"+d+"\x3c/a\x3e\x3c/p\x3e"}""==b&&(b+="\x3ch2\x3e\u5565\u90fd\u6ca1\u627e\u5230TAT\x3c/h2\x3e");b="\x3ca class\x3d'closebtn' href\x3d'javascript:void(0);' onclick\x3d'sbrclose()'\x3e\u00d7\x3c/a\x3e"+b;SC("sbr").innerHTML=b}function sbrclose(){SC("sbr").style.zIndex=-1;SC("sbr").style.opacity=0;SC("sbr").innerHTML=""}function addshow(){SC("adbtn").style.display="block";setTimeout(function(){SC("adbtn").style.opacity=1},100)}function addhide(){SC("adbtn").style.opacity=0;setTimeout(function(){SC("adbtn").style.display="none"},1E3)}SC("date").placeholder=getdate();document.addEventListener("keydown",function(a){83==a.keyCode&&(navigator.platform.match("Mac")?a.metaKey:a.ctrlKey)&&(a.preventDefault(),tempsave())});